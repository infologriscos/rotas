<!DOCTYPE html>
<html>
<head>
    <title>Visualizador de Rotograma</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 1000; }
        .hidden { display: none; }
        #info-panel { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); max-width: 300px; z-index: 1000; }
        #open-in-maps { margin-top: 10px; padding: 8px 12px; background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .custom-info-window { max-width: 250px; }
        #legend { position: absolute; bottom: 30px; left: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 1000; font-size: 12px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-icon { width: 24px; height: 24px; margin-right: 8px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">Carregando Rotograma...</div>
    <div id="info-panel" class="hidden">
        <div id="info-content"></div>
        <button id="open-in-maps" class="hidden">Abrir Rota no App do Google Maps</button>
    </div>
    <div id="legend" class="hidden"></div>

    <script>
        // Variáveis globais
        let map;
        let routeWaypoints = [];

        function initMap() {
            const urlParams = new URLSearchParams(window.location.search);
            const kmlUrl = urlParams.get('kml');
            
            if (!kmlUrl) {
                showError('Erro: Nenhuma URL de KML foi fornecida.');
                return;
            }

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center: { lat: -14.235, lng: -51.925 },
                mapTypeControl: false,
                streetViewControl: false
            });

            document.getElementById('open-in-maps').addEventListener('click', openRouteInGoogleMaps);
            loadKml(kmlUrl, map);
        }

        function loadKml(kmlUrl, map) {
            const loadingDiv = document.getElementById('loading');
            loadingDiv.classList.remove('hidden');
            
            fetch(kmlUrl)
                .then(response => {
                    if (!response.ok) { throw new Error('Falha na rede ao buscar KML'); }
                    return response.text();
                })
                .then(kmlText => {
                    processKml(kmlText, map);
                    loadingDiv.classList.add('hidden');
                })
                .catch(error => {
                    console.error('Erro ao carregar KML:', error);
                    showError('Erro ao carregar o arquivo KML. Verifique se a URL está correta e acessível.');
                });
        }

        function processKml(kmlText, map) {
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
            
            if (kmlDoc.getElementsByTagName("parsererror").length > 0) {
                showError('Erro ao processar o KML. Verifique se o arquivo é um XML válido.');
                return;
            }
            
            const styles = extractStyles(kmlDoc);
            const placemarks = kmlDoc.getElementsByTagName('Placemark');
            const bounds = new google.maps.LatLngBounds();
            
            routeWaypoints = [];
            
            for (let i = 0; i < placemarks.length; i++) {
                processPlacemark(placemarks[i], styles, map, bounds);
            }
            
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
            }
            
            showKmlInfo(kmlDoc);
            createLegend(styles);
        }

        function extractStyles(kmlDoc) {
            const styles = {};
            const styleElements = kmlDoc.getElementsByTagName('Style');
            for (let i = 0; i < styleElements.length; i++) {
                const id = '#' + styleElements[i].getAttribute('id');
                if (id) {
                    const iconHref = styleElements[i].querySelector('IconStyle > Icon > href')?.textContent;
                    const lineColor = styleElements[i].querySelector('LineStyle > color')?.textContent;
                    const lineWidth = styleElements[i].querySelector('LineStyle > width')?.textContent;
                    const polyColor = styleElements[i].querySelector('PolyStyle > color')?.textContent;
                    styles[id] = { iconHref, lineColor, lineWidth, polyColor };
                }
            }
            return styles;
        }
        
        function processPlacemark(placemark, styles, map, bounds) {
            const name = placemark.querySelector('name')?.textContent || '';
            const description = placemark.querySelector('description')?.textContent || '';
            const styleUrl = placemark.querySelector('styleUrl')?.textContent || '';
            const style = styles[styleUrl] || {};

            const point = placemark.querySelector('Point > coordinates');
            const lineString = placemark.querySelector('LineString > coordinates');
            const polygon = placemark.querySelector('Polygon > outerBoundaryIs > LinearRing > coordinates');

            if (point) {
                const coords = point.textContent.split(',').map(Number);
                const latLng = new google.maps.LatLng(coords[1], coords[0]);
                const marker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    title: name,
                    icon: style.iconHref ? { url: style.iconHref, scaledSize: new google.maps.Size(32, 32) } : null
                });
                const infoWindow = new google.maps.InfoWindow({ content: `<strong>${name}</strong><br>${description}` });
                marker.addListener('click', () => infoWindow.open(map, marker));
                bounds.extend(latLng);
            }

            if (lineString) {
                const path = parseCoordinates(lineString.textContent);
                routeWaypoints = path.slice(); // Salva a rota para o botão "Abrir no Maps"
                const polyline = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: kmlColorToCss(style.lineColor, 1),
                    strokeOpacity: 1.0,
                    strokeWeight: style.lineWidth || 4,
                    map: map
                });
                path.forEach(p => bounds.extend(p));
                document.getElementById('open-in-maps').classList.remove('hidden');
            }

            if (polygon) {
                const path = parseCoordinates(polygon.textContent);
                const shape = new google.maps.Polygon({
                    paths: path,
                    strokeColor: kmlColorToCss(style.polyColor, 1),
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: kmlColorToCss(style.polyColor, 0.35),
                    fillOpacity: 1, // Opacidade já está na cor
                    map: map
                });
                path.forEach(p => bounds.extend(p));
            }
        }

        function parseCoordinates(coordsText) {
            return coordsText.trim().split(/\s+/).map(pair => {
                const coords = pair.split(',').map(Number);
                return { lat: coords[1], lng: coords[0] };
            });
        }
        
        function kmlColorToCss(kmlColor, defaultOpacity = 1) {
            if (!kmlColor || kmlColor.length !== 8) return `rgba(0,0,255,${defaultOpacity})`;
            const a = parseInt(kmlColor.substring(0, 2), 16) / 255;
            const b = parseInt(kmlColor.substring(2, 4), 16);
            const g = parseInt(kmlColor.substring(4, 6), 16);
            const r = parseInt(kmlColor.substring(6, 8), 16);
            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }

        function showKmlInfo(kmlDoc) {
            const name = kmlDoc.querySelector('Document > name')?.textContent || 'Rotograma';
            document.getElementById('info-content').innerHTML = `<strong>${name}</strong>`;
            document.getElementById('info-panel').classList.remove('hidden');
        }

        function createLegend(styles) {
            const legend = document.getElementById('legend');
            const kmlFolders = document.querySelectorAll('Folder');
            let legendHTML = '<h6>Legenda</h6>';
            const addedIcons = new Set();

            kmlFolders.forEach(folder => {
                const placemark = folder.querySelector('Placemark');
                if (!placemark) return;

                const styleUrl = placemark.querySelector('styleUrl')?.textContent;
                if (styleUrl && styles[styleUrl] && styles[styleUrl].iconHref && !addedIcons.has(styles[styleUrl].iconHref)) {
                    const folderName = folder.querySelector('name')?.textContent || 'Pontos';
                    legendHTML += `<div class="legend-item"><img src="${styles[styleUrl].iconHref}" class="legend-icon"> ${folderName}</div>`;
                    addedIcons.add(styles[styleUrl].iconHref);
                }
            });
            
            if (addedIcons.size > 0) {
                legend.innerHTML = legendHTML;
                legend.classList.remove('hidden');
            }
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('map').innerHTML = `<div style="text-align: center; padding: 50px; font-size: 18px;">${message}</div>`;
        }
        
        function openRouteInGoogleMaps() {
            if (routeWaypoints.length < 2) return;
            const origin = routeWaypoints[0];
            const destination = routeWaypoints[routeWaypoints.length - 1];
            const waypoints = routeWaypoints.slice(1, -1).map(p => `${p.lat},${p.lng}`).join('|');
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin.lat},${origin.lng}&destination=${destination.lat},${destination.lng}&waypoints=${waypoints}&travelmode=driving`;
            window.open(url, '_blank');
        }

    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmDbEaw8opef4jzcAZePv3GFdkxDmC9tk&callback=initMap">
    </script>
</body>
</html>
